<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bile Phase 1 Test Runner</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #667eea;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .output {
            background: #f8f8f8;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .article-content {
            background: #fff;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üåê Bile Phase 1 Test Runner</h1>
        <p><strong>Purpose:</strong> Test the core infrastructure components of Bile Phase 1 implementation</p>

        <div class="test-section">
            <h3>1. Userscript Simulation Test</h3>
            <p>This simulates the userscript environment and tests basic functionality</p>
            <button onclick="runUserscriptTest()">Run Userscript Test</button>
            <div id="userscript-output" class="output"></div>
        </div>

        <div class="test-section">
            <h3>2. Article Detection Test</h3>
            <p>Tests if the current page would be detected as an article</p>
            <button onclick="testArticleDetection()">Test Article Detection</button>
            <div id="article-output" class="output"></div>
        </div>

        <div class="test-section">
            <h3>3. Content Extraction Test</h3>
            <p>Tests basic content extraction from this test page</p>
            <button onclick="testContentExtraction()">Test Content Extraction</button>
            <div id="content-output" class="output"></div>
        </div>

        <div class="test-section">
            <h3>4. HTML Generation Test</h3>
            <p>Tests the bilingual HTML generation with mock data</p>
            <button onclick="testHtmlGeneration()">Test HTML Generation</button>
            <div id="html-output" class="output"></div>
        </div>

        <div class="test-section">
            <h3>5. Full Pipeline Test</h3>
            <p>Tests the complete Phase 1 pipeline end-to-end</p>
            <button onclick="runFullPipelineTest()">Run Full Pipeline Test</button>
            <div id="pipeline-output" class="output"></div>
        </div>
    </div>

    <!-- Mock article content for testing -->
    <article class="article-content" style="display: none;">
        <h1>Test Article: German Language Learning</h1>
        <p>Dies ist ein Beispielartikel √ºber das Erlernen der deutschen Sprache.
        Es enth√§lt verschiedene <em>umgangssprachliche</em> Begriffe und kulturelle Referenzen.</p>
        <p>Learning German can be challenging, but with the right tools and approach,
        it becomes much more manageable. This article explores various techniques
        for improving your German language skills.</p>
        <p>Besonders wichtig ist es, authentische Texte zu lesen und dabei
        unbekannte Begriffe zu verstehen. Kultureller Kontext spielt eine gro√üe Rolle.</p>
    </article>

    <script>
        // Mock Greasemonkey/Tampermonkey APIs for testing
        window.GM_setValue = function(key, value) {
            localStorage.setItem('gm_' + key, JSON.stringify(value));
            return Promise.resolve();
        };

        window.GM_getValue = function(key, defaultValue) {
            const stored = localStorage.getItem('gm_' + key);
            return Promise.resolve(stored ? JSON.parse(stored) : defaultValue);
        };

        window.GM_deleteValue = function(key) {
            localStorage.removeItem('gm_' + key);
            return Promise.resolve();
        };

        window.GM_openInTab = function(url) {
            window.open(url, '_blank');
        };

        window.GM_log = function(message) {
            console.log('[GM]', message);
        };

        // Load and test Bile modules
        async function loadBileModules() {
            try {
                // In a real implementation, these would be loaded from separate files
                // For testing, we'll use simplified inline versions

                // Simplified BileStorage
                window.BileStorage = {
                    async storeApiKey(key) {
                        if (!key || !key.startsWith('sk-ant-')) {
                            throw new Error('Invalid API key format');
                        }
                        GM_setValue('bile_api_key', key);
                    },
                    async getApiKey() {
                        return await GM_getValue('bile_api_key', null);
                    },
                    async hasApiKey() {
                        const key = await this.getApiKey();
                        return key !== null;
                    },
                    async clearApiKey() {
                        GM_deleteValue('bile_api_key');
                    },
                    async getPreferences() {
                        return { targetLanguage: 'en' };
                    }
                };

                // Simplified BileApiClient
                window.BileApiClient = {
                    async testApiConnection() {
                        return await BileStorage.hasApiKey();
                    },
                    async callClaude(content, targetLang) {
                        return {
                            source_language: 'de',
                            target_language: targetLang,
                            title_original: 'Test Article',
                            title_translated: 'Test Article (Translated)',
                            content: [{
                                type: 'paragraph',
                                original: content.substring(0, 200) + '...',
                                translated: '[TRANSLATED] ' + content.substring(0, 200) + '...',
                                slang_terms: [{
                                    term: 'umgangssprachlich',
                                    translation: 'colloquial',
                                    explanation_original: 'Informelle Sprache',
                                    explanation_translated: 'Informal language'
                                }]
                            }],
                            processing_info: { phase: 1, mock_data: true }
                        };
                    },
                    handleApiError(error) {
                        console.error('API Error:', error);
                        return error.message;
                    }
                };

                // Simplified BileUtils
                window.BileUtils = {
                    debugLog(message, level = 'info') {
                        console.log(`[Bile ${level.toUpperCase()}]`, message);
                    },
                    isArticlePage() {
                        return document.querySelector('article') !== null;
                    },
                    sanitizeHtml(html) {
                        return html.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    },
                    extractPageMetadata() {
                        return {
                            title: document.title,
                            url: window.location.href,
                            domain: window.location.hostname
                        };
                    }
                };

                // Simplified BileTabGenerator
                window.BileTabGenerator = {
                    generateBasicHtml(content) {
                        return `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <meta charset="UTF-8">
                            <title>Bile - ${content.title_original}</title>
                            <style>
                                body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
                                .language-toggle { text-align: center; margin: 20px 0; }
                                .toggle-btn { padding: 10px 20px; margin: 5px; border: 2px solid #4CAF50; background: white; cursor: pointer; }
                                .toggle-btn.active { background: #4CAF50; color: white; }
                                .content-view { display: none; }
                                .content-view.active { display: block; }
                                .phase-notice { background: #e3f2fd; padding: 15px; margin: 20px 0; border-left: 4px solid #2196f3; }
                            </style>
                        </head>
                        <body>
                            <h1>üåê Bile - Phase 1 Test Result</h1>
                            <div class="phase-notice">
                                <strong>Success!</strong> This demonstrates Phase 1 core infrastructure working correctly.
                            </div>
                            <div class="language-toggle">
                                <button class="toggle-btn active" onclick="showOriginal()">Original (${content.source_language})</button>
                                <button class="toggle-btn" onclick="showTranslation()">Translation (${content.target_language})</button>
                            </div>
                            <div class="content-view active" id="original-content">
                                <h2>${content.title_original}</h2>
                                <p>${content.content[0].original}</p>
                            </div>
                            <div class="content-view" id="translated-content">
                                <h2>${content.title_translated}</h2>
                                <p>${content.content[0].translated}</p>
                            </div>
                            <scr` + `ipt>
                                function showOriginal() {
                                    document.getElementById('original-content').classList.add('active');
                                    document.getElementById('translated-content').classList.remove('active');
                                    document.querySelectorAll('.toggle-btn')[0].classList.add('active');
                                    document.querySelectorAll('.toggle-btn')[1].classList.remove('active');
                                }
                                function showTranslation() {
                                    document.getElementById('original-content').classList.remove('active');
                                    document.getElementById('translated-content').classList.add('active');
                                    document.querySelectorAll('.toggle-btn')[0].classList.remove('active');
                                    document.querySelectorAll('.toggle-btn')[1].classList.add('active');
                                }
                            </scr` + `ipt>
                        </body>
                        </html>`;
                    },
                    openInNewTab(content) {
                        try {
                            const html = this.generateBasicHtml(content);

                            // Use Blob URL instead of data URL (more reliable for large content)
                            const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
                            const url = URL.createObjectURL(blob);

                            // Try to open in new tab
                            const newWindow = window.open(url, '_blank');

                            // Clean up the URL after a delay to avoid memory leaks
                            setTimeout(() => {
                                URL.revokeObjectURL(url);
                            }, 1000);

                            // Check if popup was blocked
                            if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                                // Fallback: create download link
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = 'bile-test-result.html';
                                a.textContent = 'Download Test Result (popup blocked)';
                                a.style.display = 'block';
                                a.style.marginTop = '10px';
                                a.style.color = '#4CAF50';

                                // Find the test button and add the download link after it
                                const testButton = document.querySelector('button[onclick*="openInNewTab"]');
                                if (testButton && testButton.parentNode) {
                                    testButton.parentNode.appendChild(a);
                                }

                                alert('Popup blocked! A download link has been added below the button.');
                            }
                        } catch (error) {
                            console.error('Error in openInNewTab:', error);
                            alert('Error opening new tab: ' + error.message);
                        }
                    }
                };

                return true;
            } catch (error) {
                console.error('Failed to load Bile modules:', error);
                return false;
            }
        }

        // Test functions
        async function runUserscriptTest() {
            const output = document.getElementById('userscript-output');
            output.innerHTML = 'Running userscript simulation...';

            try {
                const loaded = await loadBileModules();
                if (loaded) {
                    output.innerHTML = '‚úÖ SUCCESS: All Bile modules loaded successfully\n' +
                                     '‚úÖ GM APIs are available\n' +
                                     '‚úÖ Core infrastructure is functional';
                    output.className = 'output success';
                } else {
                    throw new Error('Module loading failed');
                }
            } catch (error) {
                output.innerHTML = '‚ùå ERROR: ' + error.message;
                output.className = 'output error';
            }
        }

        async function testArticleDetection() {
            const output = document.getElementById('article-output');

            try {
                await loadBileModules();
                const isArticle = BileUtils.isArticlePage();
                const metadata = BileUtils.extractPageMetadata();

                output.innerHTML = `Article Detection Result: ${isArticle ? '‚úÖ DETECTED' : '‚ùå NOT DETECTED'}\n` +
                                 `Page Title: ${metadata.title}\n` +
                                 `Domain: ${metadata.domain}\n` +
                                 `Article Elements: ${document.querySelectorAll('article').length} found`;
                output.className = isArticle ? 'output success' : 'output error';
            } catch (error) {
                output.innerHTML = '‚ùå ERROR: ' + error.message;
                output.className = 'output error';
            }
        }

        async function testContentExtraction() {
            const output = document.getElementById('content-output');

            try {
                await loadBileModules();

                // Extract content from the hidden test article
                const article = document.querySelector('article');
                const title = article.querySelector('h1').textContent;
                const paragraphs = Array.from(article.querySelectorAll('p')).map(p => p.textContent);
                const content = `Title: ${title}\n\nContent:\n${paragraphs.join('\n\n')}`;

                output.innerHTML = `‚úÖ Content Extracted Successfully:\n\n${content.substring(0, 300)}...`;
                output.className = 'output success';
            } catch (error) {
                output.innerHTML = '‚ùå ERROR: ' + error.message;
                output.className = 'output error';
            }
        }

        async function testHtmlGeneration() {
            const output = document.getElementById('html-output');

            try {
                await loadBileModules();

                const mockContent = {
                    source_language: 'de',
                    target_language: 'en',
                    title_original: 'Test Article',
                    title_translated: 'Test Article (Translated)',
                    content: [{
                        type: 'paragraph',
                        original: 'Dies ist ein Test.',
                        translated: 'This is a test.',
                        slang_terms: []
                    }],
                    processing_info: { phase: 1, mock_data: true }
                };

                const html = BileTabGenerator.generateBasicHtml(mockContent);
                const preview = html.substring(0, 500) + '...';

                output.innerHTML = `‚úÖ HTML Generated Successfully!\n\nHTML Preview:\n${BileUtils.sanitizeHtml(preview)}`;
                output.className = 'output success';
            } catch (error) {
                output.innerHTML = '‚ùå ERROR: ' + error.message;
                output.className = 'output error';
            }
        }

        async function runFullPipelineTest() {
            const output = document.getElementById('pipeline-output');
            output.innerHTML = 'Running full pipeline test...';

            try {
                await loadBileModules();

                // Step 1: Store a mock API key
                await BileStorage.storeApiKey('sk-ant-test-key-for-phase1-testing-12345');
                output.innerHTML += '\n‚úÖ Step 1: API key storage - SUCCESS';

                // Step 2: Test API connection
                const connected = await BileApiClient.testApiConnection();
                if (!connected) throw new Error('API connection test failed');
                output.innerHTML += '\n‚úÖ Step 2: API connection test - SUCCESS';

                // Step 3: Extract content
                const article = document.querySelector('article');
                const content = article.textContent;
                output.innerHTML += '\n‚úÖ Step 3: Content extraction - SUCCESS';

                // Step 4: Process content
                const processed = await BileApiClient.callClaude(content, 'en');
                output.innerHTML += '\n‚úÖ Step 4: Content processing - SUCCESS';

                // Step 5: Generate HTML
                const html = BileTabGenerator.generateBasicHtml(processed);
                output.innerHTML += '\n‚úÖ Step 5: HTML generation - SUCCESS';

                // Step 6: Open in new tab (simulated)
                output.innerHTML += '\n‚úÖ Step 6: New tab ready for opening';

                output.innerHTML += '\n\nüéâ FULL PIPELINE TEST COMPLETED SUCCESSFULLY!';
                output.innerHTML += '\nPhase 1 core infrastructure is working correctly.';

                // Add button to test the actual tab opening
                const testButton = document.createElement('button');
                testButton.textContent = 'Open Test Result in New Tab';
                testButton.onclick = () => {
                    try {
                        console.log('Button clicked, processed data:', processed);
                        console.log('BileTabGenerator available:', !!window.BileTabGenerator);
                        BileTabGenerator.openInNewTab(processed);
                    } catch (error) {
                        console.error('Error opening new tab:', error);
                        alert('Error: ' + error.message);
                    }
                };
                output.appendChild(document.createElement('br'));
                output.appendChild(testButton);

                output.className = 'output success';

                // Clean up test data
                await BileStorage.clearApiKey();

            } catch (error) {
                output.innerHTML += '\n‚ùå ERROR: ' + error.message;
                output.className = 'output error';
            }
        }

        // Auto-run basic test on page load
        window.addEventListener('load', () => {
            console.log('Bile Phase 1 Test Runner loaded');
        });
    </script>
</body>
</html>